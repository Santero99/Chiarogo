<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat - ChiaraGo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a1a">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a1a; --bg2:#0f0f2a; --surface:#13132a; --surface2:#1a1a35;
    --border:rgba(124,58,237,0.2); --border2:rgba(124,58,237,0.4);
    --primary:#7c3aed; --primary-light:#9d5cf8;
    --accent:#f472b6; --accent2:#38bdf8;
    --text:#f0f0ff; --text2:#a0a0c0; --text3:#606080;
    --online:#22c55e; --radius:16px; --radius-sm:10px; --radius-full:9999px;
    --font-head:'Syne',sans-serif; --font-body:'DM Sans',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);height:100dvh;
    display:flex;flex-direction:column;overflow:hidden;}
  .header{background:var(--surface);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:10px;flex-shrink:0;
    padding-top:max(10px,env(safe-area-inset-top));}
  .back-btn{color:var(--text2);padding:6px;cursor:pointer;display:flex;align-items:center;text-decoration:none;}
  .back-btn svg{width:22px;height:22px;}
  .header-info{flex:1;min-width:0;cursor:pointer;}
  .header-name{font-family:var(--font-head);font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .header-status{font-size:12px;color:var(--text3);}
  .header-status.online{color:var(--online);}
  .header-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
    display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:700;font-size:16px;flex-shrink:0;overflow:hidden;}
  .header-avatar img{width:100%;height:100%;object-fit:cover;}
  .header-actions{display:flex;gap:4px;}
  .icon-btn{color:var(--text2);padding:7px;cursor:pointer;border-radius:8px;transition:background .2s;display:flex;align-items:center;text-decoration:none;}
  .icon-btn:hover{background:var(--surface2);}
  .icon-btn svg{width:20px;height:20px;}
  .messages{flex:1;overflow-y:auto;padding:12px 12px 8px;display:flex;flex-direction:column;gap:4px;
    scroll-behavior:smooth;}
  .messages::-webkit-scrollbar{width:4px;}
  .messages::-webkit-scrollbar-track{background:transparent;}
  .messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .day-divider{text-align:center;margin:12px 0;}
  .day-label{background:var(--surface);border:1px solid var(--border);color:var(--text3);
    font-size:11px;padding:4px 12px;border-radius:var(--radius-full);}
  .msg{display:flex;gap:8px;max-width:75%;animation:msgIn .2s ease;}
  @keyframes msgIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
  .msg.sent{align-self:flex-end;flex-direction:row-reverse;}
  .msg.received{align-self:flex-start;}
  .msg-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
    display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;
    align-self:flex-end;overflow:hidden;}
  .msg-avatar img{width:100%;height:100%;object-fit:cover;}
  .msg-bubble{background:var(--surface2);border-radius:18px;padding:10px 14px;
    border-bottom-left-radius:4px;max-width:100%;word-break:break-word;}
  .msg.sent .msg-bubble{background:linear-gradient(135deg,var(--primary),var(--primary-light));
    border-bottom-left-radius:18px;border-bottom-right-radius:4px;color:#fff;}
  .msg-text{font-size:15px;line-height:1.5;}
  .msg-media{max-width:220px;border-radius:12px;overflow:hidden;cursor:pointer;}
  .msg-media img{width:100%;display:block;}
  .msg-file{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);
    border-radius:10px;padding:8px;min-width:180px;}
  .msg-file-icon{width:36px;height:36px;background:var(--primary);border-radius:8px;
    display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
  .msg-file-info{flex:1;min-width:0;}
  .msg-file-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .msg-file-size{font-size:11px;color:var(--text3);}
  .msg-meta{display:flex;align-items:center;gap:4px;margin-top:4px;}
  .msg-time{font-size:10px;opacity:.6;}
  .msg.sent .msg-time{color:rgba(255,255,255,.7);}
  .msg-status{font-size:12px;opacity:.7;}
  .typing-indicator{display:flex;gap:4px;padding:12px 16px;align-self:flex-start;}
  .typing-dot{width:7px;height:7px;background:var(--text3);border-radius:50%;animation:typing .8s infinite;}
  .typing-dot:nth-child(2){animation-delay:.2s;}
  .typing-dot:nth-child(3){animation-delay:.4s;}
  @keyframes typing{0%,80%,100%{transform:scale(0.8);opacity:.4;}40%{transform:scale(1.1);opacity:1;}}
  .input-area{background:var(--surface);border-top:1px solid var(--border);
    padding:8px 12px max(8px,env(safe-area-inset-bottom));flex-shrink:0;}
  .input-wrap{display:flex;align-items:flex-end;gap:8px;}
  .attach-btn{color:var(--text3);padding:8px;cursor:pointer;display:flex;align-items:center;border-radius:50%;transition:color .2s;}
  .attach-btn:hover{color:var(--primary-light);}
  .attach-btn svg{width:22px;height:22px;}
  .msg-input-wrap{flex:1;background:var(--surface2);border:1.5px solid var(--border);
    border-radius:22px;padding:10px 14px;min-height:44px;max-height:120px;overflow-y:auto;
    display:flex;align-items:center;transition:border-color .2s;}
  .msg-input-wrap:focus-within{border-color:var(--primary);}
  .msg-input{flex:1;outline:none;color:var(--text);font-family:var(--font-body);font-size:15px;
    background:transparent;resize:none;border:none;line-height:1.4;}
  .msg-input[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--text3);}
  .send-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-light));
    border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:transform .15s,opacity .2s;flex-shrink:0;}
  .send-btn:hover{transform:scale(1.05);}
  .send-btn:disabled{opacity:.4;cursor:default;transform:none;}
  .send-btn svg{width:20px;height:20px;}
  .emoji-btn{color:var(--text3);padding:4px;cursor:pointer;font-size:18px;}
  /* Attach menu */
  .attach-menu{position:absolute;bottom:80px;left:12px;background:var(--surface2);
    border:1px solid var(--border2);border-radius:var(--radius);padding:8px;
    display:none;flex-direction:column;gap:4px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.4);}
  .attach-menu.open{display:flex;}
  .attach-opt{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;
    border-radius:10px;transition:background .15s;color:var(--text2);font-size:14px;}
  .attach-opt:hover{background:var(--border);}
  .attach-opt-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
  /* Context menu */
  .ctx-menu{position:fixed;background:var(--surface2);border:1px solid var(--border2);
    border-radius:var(--radius-sm);padding:6px;z-index:200;box-shadow:0 8px 24px rgba(0,0,0,.5);}
  .ctx-item{padding:9px 16px;cursor:pointer;border-radius:6px;font-size:14px;white-space:nowrap;transition:background .15s;}
  .ctx-item:hover{background:var(--border);}
  .ctx-item.danger{color:var(--accent);}
  .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;
    flex:1;gap:12px;opacity:.5;padding:24px;}
  .empty-state-icon{font-size:56px;}
  /* Reaction bar */
  .reaction-bar{display:flex;gap:6px;background:var(--surface2);border-radius:var(--radius-full);
    padding:4px 8px;border:1px solid var(--border);}
  .reaction{font-size:20px;cursor:pointer;transition:transform .15s;}
  .reaction:hover{transform:scale(1.3);}
  .reactions{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;}
  .react-pill{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.08);
    border-radius:var(--radius-full);padding:2px 8px;font-size:12px;cursor:pointer;}
  input[type=file]{display:none;}
</style>
</head>
<body>
<header class="header" id="chatHeader">
  <a href="index.html" class="back-btn">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
  </a>
  <div class="header-avatar" id="chatAvatar"></div>
  <div class="header-info" onclick="viewProfile()">
    <div class="header-name" id="chatName">Carregando...</div>
    <div class="header-status" id="chatStatus">offline</div>
  </div>
  <div class="header-actions">
    <a href="#" class="icon-btn" id="audioCallBtn" onclick="startAudioCall()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
    </a>
    <a href="chamada.html" class="icon-btn" id="videoCallBtn">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.069A1 1 0 0121 8.82v6.36a1 1 0 01-1.447.894L15 14M3 8a2 2 0 012-2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/></svg>
    </a>
    <div class="icon-btn" onclick="toggleMenu()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>
    </div>
  </div>
</header>

<div class="messages" id="messages">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:8px;opacity:.4;padding:40px 0;">
    <div style="font-size:48px">üí¨</div>
    <div style="font-size:14px;color:var(--text3)">Carregando mensagens...</div>
  </div>
</div>

<div id="typingArea"></div>

<div class="input-area">
  <div class="input-wrap">
    <div class="attach-btn" onclick="toggleAttach()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
    </div>
    <div class="msg-input-wrap">
      <div class="msg-input" id="msgInput" contenteditable="true" data-placeholder="Mensagem..." 
        onkeydown="handleKey(event)" oninput="handleTyping()"></div>
    </div>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
    </button>
  </div>
</div>

<!-- Attach menu -->
<div class="attach-menu" id="attachMenu">
  <div class="attach-opt" onclick="triggerFile('image')"><div class="attach-opt-icon" style="background:rgba(56,189,248,.2)">üñºÔ∏è</div>Imagem/V√≠deo</div>
  <div class="attach-opt" onclick="triggerFile('file')"><div class="attach-opt-icon" style="background:rgba(124,58,237,.2)">üìÑ</div>Arquivo</div>
  <div class="attach-opt" onclick="sendLocation()"><div class="attach-opt-icon" style="background:rgba(34,197,94,.2)">üìç</div>Localiza√ß√£o</div>
</div>
<input type="file" id="fileImage" accept="image/*,video/*" onchange="uploadMedia(this,'image')">
<input type="file" id="fileDoc" onchange="uploadMedia(this,'file')">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
<script>
let convId = null, otherUser = null, channel = null, typingTimeout = null, isTyping = false;
const urlParams = new URLSearchParams(window.location.search);
convId = urlParams.get('id');
const targetUserId = urlParams.get('user');

document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
  if (!await App.requireAuth()) return;

  if (!convId && targetUserId) {
    // Find or create conversation
    const { data: existing } = await window.supabaseClient
      .from('conversation_participants')
      .select('conversation_id')
      .eq('user_id', App.currentUser.id);
    if (existing) {
      const convIds = existing.map(e => e.conversation_id);
      const { data: shared } = await window.supabaseClient
        .from('conversation_participants')
        .select('conversation_id')
        .eq('user_id', targetUserId)
        .in('conversation_id', convIds);
      if (shared && shared.length > 0) {
        convId = shared[0].conversation_id;
      } else {
        // Create new
        const { data: conv } = await window.supabaseClient.from('conversations').insert({}).select().single();
        convId = conv.id;
        await window.supabaseClient.from('conversation_participants').insert([
          { conversation_id: convId, user_id: App.currentUser.id },
          { conversation_id: convId, user_id: targetUserId }
        ]);
      }
    }
  }

  if (!convId) { window.location.href = 'index.html'; return; }

  await loadConvInfo();
  await loadMessages();
  subscribeMessages();
  subscribeTyping();
  markRead();
});

async function loadConvInfo() {
  const { data } = await window.supabaseClient
    .from('conversation_participants')
    .select('user_id, profiles(id, username, full_name, avatar_url, is_online, last_seen)')
    .eq('conversation_id', convId)
    .neq('user_id', App.currentUser.id)
    .single();
  if (!data) return;
  otherUser = data.profiles;
  const name = otherUser.full_name || otherUser.username || 'Usu√°rio';
  document.getElementById('chatName').textContent = name;
  document.title = `${name} - ChiaraGo`;
  const status = document.getElementById('chatStatus');
  if (otherUser.is_online) { status.textContent = 'online'; status.className = 'header-status online'; }
  else { status.textContent = otherUser.last_seen ? `visto ${App.formatDate(otherUser.last_seen)}` : 'offline'; }
  const av = document.getElementById('chatAvatar');
  if (otherUser.avatar_url) av.innerHTML = `<img src="${otherUser.avatar_url}" alt="">`;
  else av.textContent = name[0].toUpperCase();
}

async function loadMessages() {
  const { data } = await window.supabaseClient
    .from('messages')
    .select('*')
    .eq('conversation_id', convId)
    .order('created_at', { ascending: true })
    .limit(100);
  renderMessages(data || []);
}

function renderMessages(msgs) {
  const container = document.getElementById('messages');
  if (!msgs.length) {
    container.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:8px;opacity:.4;padding:40px 0;"><div style="font-size:56px">üëã</div><div style="color:var(--text3);font-size:14px">Diga ol√°!</div></div>`;
    return;
  }
  let lastDate = null;
  container.innerHTML = '';
  msgs.forEach(msg => {
    const d = new Date(msg.created_at).toDateString();
    if (d !== lastDate) {
      const divider = document.createElement('div');
      divider.className = 'day-divider';
      divider.innerHTML = `<span class="day-label">${App.formatDate(msg.created_at)}</span>`;
      container.appendChild(divider);
      lastDate = d;
    }
    container.appendChild(createMsgEl(msg));
  });
  container.scrollTop = container.scrollHeight;
}

function createMsgEl(msg) {
  const isSent = msg.sender_id === App.currentUser.id;
  const div = document.createElement('div');
  div.className = `msg ${isSent ? 'sent' : 'received'}`;
  div.dataset.id = msg.id;
  let content = '';
  if (msg.type === 'image') {
    content = `<div class="msg-media"><img src="${msg.content}" loading="lazy" onclick="viewImage('${msg.content}')"></div>`;
  } else if (msg.type === 'file') {
    const meta = JSON.parse(msg.metadata || '{}');
    content = `<div class="msg-file"><div class="msg-file-icon">üìÑ</div><div class="msg-file-info"><div class="msg-file-name">${meta.name||'Arquivo'}</div><div class="msg-file-size">${meta.size||''}</div></div></div>`;
  } else {
    content = `<div class="msg-text">${escapeHtml(msg.content)}</div>`;
  }
  const statusIcon = isSent ? (msg.is_read ? '‚úì‚úì' : '‚úì') : '';
  div.innerHTML = `
    ${!isSent ? `<div class="msg-avatar">${otherUser?.avatar_url ? `<img src="${otherUser.avatar_url}">` : (otherUser?.full_name||'U')[0]}</div>` : ''}
    <div class="msg-bubble">
      ${content}
      <div class="msg-meta">
        <span class="msg-time">${App.formatTime(msg.created_at)}</span>
        ${isSent ? `<span class="msg-status">${statusIcon}</span>` : ''}
      </div>
    </div>`;
  div.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, msg); });
  return div;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function subscribeMessages() {
  channel = window.supabaseClient.channel(`conv:${convId}`)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`conversation_id=eq.${convId}` },
      async (payload) => {
        const msg = payload.new;
        const container = document.getElementById('messages');
        const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 60;
        container.appendChild(createMsgEl(msg));
        if (isAtBottom || msg.sender_id === App.currentUser.id) container.scrollTop = container.scrollHeight;
        if (msg.sender_id !== App.currentUser.id) markRead();
      })
    .subscribe();
}

function subscribeTyping() {
  window.supabaseClient.channel(`typing:${convId}`)
    .on('broadcast', { event:'typing' }, payload => {
      if (payload.payload.userId !== App.currentUser.id) {
        const area = document.getElementById('typingArea');
        area.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => area.innerHTML = '', 2000);
      }
    }).subscribe();
}

async function handleTyping() {
  if (!isTyping) {
    isTyping = true;
    window.supabaseClient.channel(`typing:${convId}`).send({ type:'broadcast', event:'typing', payload:{ userId: App.currentUser.id } });
    setTimeout(() => { isTyping = false; }, 1500);
  }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.textContent.trim();
  if (!text) return;
  input.textContent = '';
  try {
    await window.supabaseClient.from('messages').insert({
      conversation_id: convId, sender_id: App.currentUser.id,
      content: text, type: 'text', is_read: false
    });
    await window.supabaseClient.from('conversations').update({ updated_at: new Date().toISOString() }).eq('id', convId);
  } catch(e) { App.showToast('Erro ao enviar', 'error'); input.textContent = text; }
}

async function markRead() {
  await window.supabaseClient.from('messages')
    .update({ is_read: true })
    .eq('conversation_id', convId)
    .neq('sender_id', App.currentUser.id)
    .eq('is_read', false);
}

function toggleAttach() { document.getElementById('attachMenu').classList.toggle('open'); }
function triggerFile(type) {
  document.getElementById('attachMenu').classList.remove('open');
  document.getElementById(type === 'image' ? 'fileImage' : 'fileDoc').click();
}
async function uploadMedia(input, type) {
  const file = input.files[0]; if (!file) return;
  App.showToast('Enviando arquivo...', 'info');
  try {
    const ext = file.name.split('.').pop();
    const path = `messages/${convId}/${Date.now()}.${ext}`;
    await window.supabaseClient.storage.from('media').upload(path, file);
    const { data: url } = window.supabaseClient.storage.from('media').getPublicUrl(path);
    const metadata = JSON.stringify({ name: file.name, size: formatBytes(file.size) });
    await window.supabaseClient.from('messages').insert({
      conversation_id: convId, sender_id: App.currentUser.id,
      content: url.publicUrl, type, metadata, is_read: false
    });
    App.showToast('Enviado!', 'success');
  } catch(e) { App.showToast('Erro no upload', 'error'); }
  input.value = '';
}

function formatBytes(b) { if (b < 1024) return b+'B'; if (b < 1048576) return (b/1024).toFixed(1)+'KB'; return (b/1048576).toFixed(1)+'MB'; }
function viewProfile() { if (otherUser) window.location.href = `perfil.html?id=${otherUser.id}`; }
function startAudioCall() { window.location.href = `chamada.html?user=${otherUser?.id}&type=audio`; }
function viewImage(url) { window.open(url, '_blank'); }
function sendLocation() {
  document.getElementById('attachMenu').classList.remove('open');
  App.showToast('Funcionalidade em breve!');
}

let ctxMenu = null;
function showCtxMenu(e, msg) {
  if (ctxMenu) ctxMenu.remove();
  ctxMenu = document.createElement('div');
  ctxMenu.className = 'ctx-menu';
  const actions = [
    { label: '‚Ü©Ô∏è Responder', fn: () => {} },
    { label: 'üìã Copiar', fn: () => { navigator.clipboard.writeText(msg.content); App.showToast('Copiado!'); } },
  ];
  if (msg.sender_id === App.currentUser.id) actions.push({ label: 'üóëÔ∏è Apagar', fn: async () => { await window.supabaseClient.from('messages').delete().eq('id', msg.id); document.querySelector(`[data-id="${msg.id}"]`)?.remove(); }, cls: 'danger' });
  actions.forEach(a => {
    const item = document.createElement('div');
    item.className = `ctx-item ${a.cls||''}`;
    item.textContent = a.label;
    item.onclick = () => { a.fn(); ctxMenu.remove(); };
    ctxMenu.appendChild(item);
  });
  ctxMenu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
  ctxMenu.style.top = Math.min(e.clientY, window.innerHeight - 120) + 'px';
  document.body.appendChild(ctxMenu);
  setTimeout(() => document.addEventListener('click', () => ctxMenu?.remove(), { once: true }), 10);
}
function toggleMenu() {}
</script>
</body>
</html>
