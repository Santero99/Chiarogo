<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Contatos - ChiaraGo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a1a;--surface:#13132a;--surface2:#1a1a35;--border:rgba(124,58,237,.2);--border2:rgba(124,58,237,.4);--primary:#7c3aed;--primary-light:#9d5cf8;--accent:#f472b6;--text:#f0f0ff;--text2:#a0a0c0;--text3:#606080;--online:#22c55e;--radius:16px;--radius-sm:10px;--radius-full:9999px;--font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100dvh;}
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:max(12px,env(safe-area-inset-top)) 16px 12px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50;}
  .back-btn{color:var(--text2);padding:6px;cursor:pointer;text-decoration:none;display:flex;}
  .back-btn svg{width:22px;height:22px;}
  .header-title{font-family:var(--font-head);font-size:18px;font-weight:700;flex:1;}
  .icon-btn{color:var(--text2);padding:7px;cursor:pointer;border-radius:8px;display:flex;transition:background .2s;}
  .icon-btn:hover{background:var(--surface2);}
  .icon-btn svg{width:20px;height:20px;}
  .search-bar{padding:10px 16px;position:sticky;top:57px;background:var(--surface);z-index:40;border-bottom:1px solid var(--border);}
  .search-wrap{position:relative;}
  .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);width:18px;height:18px;}
  .search-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-full);padding:10px 16px 10px 40px;color:var(--text);font-family:var(--font-body);font-size:14px;outline:none;}
  .search-input::placeholder{color:var(--text3);}
  .tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:calc(57px + 55px);z-index:39;}
  .tab{flex:1;padding:12px;text-align:center;font-size:14px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;}
  .tab.active{color:var(--primary-light);border-bottom-color:var(--primary);}
  .page{padding:0 0 80px;}
  .alpha-header{padding:6px 16px;background:var(--surface2);color:var(--text3);font-size:12px;font-weight:700;letter-spacing:.06em;}
  .contact-item{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid rgba(255,255,255,.03);text-decoration:none;}
  .contact-item:hover{background:var(--surface);}
  .contact-avatar{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:700;font-size:18px;overflow:hidden;flex-shrink:0;position:relative;}
  .contact-avatar img{width:100%;height:100%;object-fit:cover;}
  .online-dot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;background:var(--online);border-radius:50%;border:2px solid var(--bg);}
  .contact-info{flex:1;min-width:0;}
  .contact-name{font-weight:600;font-size:15px;}
  .contact-sub{color:var(--text3);font-size:13px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .contact-actions{display:flex;gap:4px;}
  .action-btn{width:34px;height:34px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s;text-decoration:none;color:var(--text2);}
  .action-btn:hover{background:var(--border);}
  .action-btn svg{width:16px;height:16px;}
  .fab{position:fixed;bottom:88px;right:16px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px rgba(124,58,237,.5);z-index:99;}
  .fab svg{width:24px;height:24px;}
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));z-index:100;}
  .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 12px;cursor:pointer;color:var(--text3);text-decoration:none;transition:color .2s;}
  .nav-item.active{color:var(--primary-light);}
  .nav-item svg{width:24px;height:24px;}
  .nav-item span{font-size:10px;font-weight:500;}
  .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;gap:12px;text-align:center;}
  .empty-icon{font-size:56px;opacity:.4;}
  .empty-state p{color:var(--text3);font-size:14px;}
  /* Add contact modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:480px;}
  .modal-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 20px;}
  .modal h3{font-family:var(--font-head);font-size:18px;margin-bottom:16px;}
  input{width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;color:var(--text);font-family:var(--font-body);font-size:15px;outline:none;margin-bottom:12px;transition:border-color .2s;}
  input:focus{border-color:var(--primary);}
  .btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;border-radius:var(--radius-full);color:#fff;font-family:var(--font-head);font-size:14px;font-weight:700;cursor:pointer;}
  .search-result{display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:10px;cursor:pointer;}
  .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);color:var(--text);padding:12px 24px;border-radius:var(--radius-full);font-size:14px;opacity:0;transition:all .3s;z-index:9999;border:1px solid var(--border2);}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .loading-dots{display:flex;gap:6px;justify-content:center;padding:24px;}
  .dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:bounce .6s infinite alternate;}
  .dot:nth-child(2){animation-delay:.2s;} .dot:nth-child(3){animation-delay:.4s;}
  @keyframes bounce{to{transform:translateY(-8px);opacity:.4;}}
</style>
</head>
<body>
<header class="header">
  <a href="index.html" class="back-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></a>
  <div class="header-title">Contatos</div>
  <div class="icon-btn" onclick="showAddModal()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg></div>
</header>

<div class="search-bar">
  <div class="search-wrap">
    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="M21 21l-4.35-4.35"/></svg>
    <input class="search-input" id="searchInput" placeholder="Pesquisar contatos..." oninput="filterContacts(this.value)">
  </div>
</div>

<div class="tabs">
  <div class="tab active" id="tabAll" onclick="switchTab('all')">Todos</div>
  <div class="tab" id="tabOnline" onclick="switchTab('online')">Online</div>
  <div class="tab" id="tabRecent" onclick="switchTab('recent')">Recentes</div>
</div>

<div class="page">
  <div id="loading" class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  <div id="contactsList"></div>
  <div class="empty-state" id="emptyState" style="display:none">
    <div class="empty-icon">ðŸ‘¥</div>
    <h3 style="font-family:var(--font-head);font-size:18px;">Nenhum contato</h3>
    <p>Adicione amigos para comeÃ§ar a conversar!</p>
  </div>
</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><span>Chats</span></a>
  <a href="status.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3"/></svg><span>Status</span></a>
  <a href="contatos.html" class="nav-item active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Contatos</span></a>
  <a href="notificacoes.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span>Alertas</span></a>
  <a href="configuracoes.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg><span>Config.</span></a>
</nav>

<!-- Add Contact Modal -->
<div class="modal-overlay" id="addModal" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Adicionar Contato</h3>
    <input id="searchUser" type="text" placeholder="Pesquisar por @username ou nome..." oninput="searchUsers(this.value)">
    <div id="userResults"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
<script>
let allContacts = [], currentTab = 'all';

document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
  if (!await App.requireAuth()) return;
  await loadContacts();
});

async function loadContacts() {
  document.getElementById('loading').style.display = 'flex';
  const { data } = await window.supabaseClient
    .from('contacts')
    .select('*, profiles:contact_id(id,full_name,username,avatar_url,is_online,last_seen,bio)')
    .eq('user_id', App.currentUser.id);
  document.getElementById('loading').style.display = 'none';
  allContacts = (data || []).map(c => c.profiles).filter(Boolean);
  renderContacts(allContacts);
}

function renderContacts(contacts) {
  const list = document.getElementById('contactsList');
  const empty = document.getElementById('emptyState');
  list.innerHTML = '';
  if (!contacts.length) { empty.style.display = 'flex'; return; }
  empty.style.display = 'none';

  let lastLetter = null;
  const sorted = [...contacts].sort((a,b) => (a.full_name||'').localeCompare(b.full_name||''));
  sorted.forEach(c => {
    const letter = (c.full_name||c.username||'?')[0].toUpperCase();
    if (letter !== lastLetter) {
      const h = document.createElement('div'); h.className='alpha-header'; h.textContent=letter;
      list.appendChild(h); lastLetter=letter;
    }
    const item = document.createElement('a');
    item.href = `perfil.html?id=${c.id}`;
    item.className = 'contact-item';
    item.innerHTML = `
      <div class="contact-avatar">
        ${c.avatar_url?`<img src="${c.avatar_url}" alt="">`:(c.full_name||'?')[0]}
        ${c.is_online?'<div class="online-dot"></div>':''}
      </div>
      <div class="contact-info">
        <div class="contact-name">${c.full_name||c.username||'UsuÃ¡rio'}</div>
        <div class="contact-sub">${c.is_online?'ðŸŸ¢ Online':(c.bio||`@${c.username}`)}</div>
      </div>
      <div class="contact-actions" onclick="e=>e.preventDefault()">
        <a href="chat.html?user=${c.id}" class="action-btn" onclick="event.stopPropagation()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        </a>
        <a href="chamada.html?user=${c.id}&type=audio" class="action-btn" onclick="event.stopPropagation()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
        </a>
      </div>`;
    list.appendChild(item);
  });
}

function filterContacts(q) {
  const f = allContacts.filter(c => (c.full_name||'').toLowerCase().includes(q.toLowerCase()) || (c.username||'').toLowerCase().includes(q.toLowerCase()));
  renderContacts(f);
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active');
  if (tab === 'online') renderContacts(allContacts.filter(c => c.is_online));
  else if (tab === 'recent') renderContacts(allContacts.slice(0,20));
  else renderContacts(allContacts);
}

function showAddModal() { document.getElementById('addModal').classList.add('open'); }
function closeModal(e) { if (e.target.classList.contains('modal-overlay')) document.getElementById('addModal').classList.remove('open'); }

let searchTimeout;
async function searchUsers(q) {
  clearTimeout(searchTimeout);
  const results = document.getElementById('userResults');
  if (q.length < 2) { results.innerHTML = ''; return; }
  searchTimeout = setTimeout(async () => {
    const term = q.startsWith('@') ? q.slice(1) : q;
    const { data } = await window.supabaseClient.from('profiles').select('id,full_name,username,avatar_url').or(`username.ilike.%${term}%,full_name.ilike.%${term}%`).neq('id', App.currentUser.id).limit(8);
    results.innerHTML = '';
    (data||[]).forEach(u => {
      const div = document.createElement('div'); div.className='search-result';
      div.innerHTML = `
        <div class="contact-avatar" style="width:38px;height:38px;font-size:15px;flex-shrink:0">
          ${u.avatar_url?`<img src="${u.avatar_url}">`:u.full_name[0]}
        </div>
        <div class="contact-info"><div style="font-weight:600">${u.full_name}</div><div style="font-size:12px;color:var(--text3)">@${u.username}</div></div>
        <button style="background:var(--primary);border:none;color:#fff;padding:6px 12px;border-radius:var(--radius-full);font-family:var(--font-head);font-size:12px;cursor:pointer;" onclick="addContact('${u.id}', this)">Adicionar</button>`;
      results.appendChild(div);
    });
    if (!data?.length) results.innerHTML = `<p style="color:var(--text3);font-size:14px;text-align:center;padding:16px;">Nenhum usuÃ¡rio encontrado</p>`;
  }, 400);
}

async function addContact(userId, btn) {
  btn.disabled=true; btn.textContent='Adicionando...';
  const { error } = await window.supabaseClient.from('contacts').insert({ user_id: App.currentUser.id, contact_id: userId });
  if (error) { btn.disabled=false; btn.textContent='Adicionar'; return; }
  btn.textContent='âœ“ Adicionado'; btn.style.background='var(--online)';
  await loadContacts();
}

function showToast(msg) {
  const t = document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
</body>
</html>
