<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Arquivos - ChiaraGo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a1a;--surface:#13132a;--surface2:#1a1a35;--border:rgba(124,58,237,.2);--primary:#7c3aed;--primary-light:#9d5cf8;--accent:#f472b6;--text:#f0f0ff;--text2:#a0a0c0;--text3:#606080;--online:#22c55e;--radius:16px;--radius-sm:10px;--radius-full:9999px;--font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100dvh;padding-bottom:32px;}
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:max(12px,env(safe-area-inset-top)) 16px 12px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50;}
  .back-btn{color:var(--text2);padding:6px;cursor:pointer;text-decoration:none;display:flex;border-radius:8px;}
  .back-btn:hover{background:var(--surface2);}
  .back-btn svg{width:22px;height:22px;}
  .header-title{font-family:var(--font-head);font-size:18px;font-weight:700;flex:1;}
  .storage-card{margin:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
  .storage-title{font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:12px;}
  .storage-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-bottom:8px;}
  .storage-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:4px;transition:width 1s;}
  .storage-info{display:flex;justify-content:space-between;font-size:13px;color:var(--text3);}
  .storage-used{font-weight:600;color:var(--text);}
  .tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);margin-bottom:0;}
  .tab{flex:1;padding:12px;text-align:center;font-size:14px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;}
  .tab.active{color:var(--primary-light);border-bottom-color:var(--primary);}
  .upload-zone{margin:16px;border:2px dashed var(--border2);border-radius:var(--radius);padding:40px 24px;text-align:center;cursor:pointer;transition:all .2s;}
  .upload-zone:hover,.upload-zone.drag{border-color:var(--primary);background:rgba(124,58,237,.05);}
  .upload-zone-icon{font-size:48px;margin-bottom:12px;}
  .upload-zone h3{font-family:var(--font-head);font-size:16px;margin-bottom:6px;}
  .upload-zone p{color:var(--text3);font-size:13px;}
  .btn-upload{margin-top:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;color:#fff;padding:10px 24px;border-radius:var(--radius-full);font-family:var(--font-head);font-size:14px;font-weight:700;cursor:pointer;}
  .progress-card{margin:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:none;}
  .progress-card.show{display:block;}
  .progress-file{font-weight:600;font-size:14px;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .progress-bar-wrap{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;}
  .progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .3s;}
  .progress-pct{font-size:12px;color:var(--text3);margin-top:6px;text-align:right;}
  .file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:16px;}
  .file-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;transition:transform .15s;}
  .file-card:hover{transform:translateY(-2px);}
  .file-preview{height:100px;display:flex;align-items:center;justify-content:center;background:var(--surface2);font-size:36px;}
  .file-preview img{width:100%;height:100%;object-fit:cover;}
  .file-info{padding:8px;}
  .file-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .file-size{font-size:11px;color:var(--text3);margin-top:2px;}
  .file-list{padding:16px;}
  .file-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--radius-sm);margin-bottom:8px;}
  .file-row-icon{width:40px;height:40px;border-radius:10px;background:rgba(124,58,237,.15);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
  .file-row-info{flex:1;min-width:0;}
  .file-row-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .file-row-meta{font-size:12px;color:var(--text3);margin-top:2px;}
  .delete-btn{color:var(--accent);background:none;border:none;cursor:pointer;font-size:16px;padding:4px;}
  .section-label{padding:16px 16px 8px;font-family:var(--font-head);font-size:13px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;}
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);color:var(--text);padding:12px 24px;border-radius:var(--radius-full);font-size:14px;opacity:0;transition:all .3s;z-index:9999;border:1px solid var(--border);}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  input[type=file]{display:none;}
  .empty{text-align:center;padding:40px;opacity:.4;font-size:14px;color:var(--text3);}
</style>
</head>
<body>
<header class="header">
  <a href="configuracoes.html" class="back-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></a>
  <div class="header-title">Arquivos e M√≠dia</div>
</header>

<div class="storage-card">
  <div class="storage-title">Armazenamento</div>
  <div class="storage-bar"><div class="storage-fill" id="storageFill" style="width:0%"></div></div>
  <div class="storage-info"><span class="storage-used" id="storageUsed">0 MB</span><span id="storageTotal">de 1 GB gr√°tis</span></div>
</div>

<div class="tabs">
  <div class="tab active" id="tabUpload" onclick="switchTab('upload')">Enviar</div>
  <div class="tab" id="tabImages" onclick="switchTab('images')">Imagens</div>
  <div class="tab" id="tabDocs" onclick="switchTab('docs')">Docs</div>
</div>

<!-- Upload Tab -->
<div id="uploadTab">
  <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()"
    ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
    <div class="upload-zone-icon">‚òÅÔ∏è</div>
    <h3>Enviar Arquivo</h3>
    <p>Arraste e solte ou clique para selecionar<br>M√°x. 50MB por arquivo</p>
    <button class="btn-upload" onclick="event.stopPropagation();document.getElementById('fileInput').click()">Selecionar Arquivo</button>
  </div>
  <div class="progress-card" id="progressCard">
    <div class="progress-file" id="progressFile">arquivo.jpg</div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-pct" id="progressPct">0%</div>
  </div>
</div>

<!-- Images Tab -->
<div id="imagesTab" style="display:none">
  <div class="section-label">Imagens Enviadas</div>
  <div class="file-grid" id="imageGrid"><div class="empty">Carregando...</div></div>
</div>

<!-- Docs Tab -->
<div id="docsTab" style="display:none">
  <div class="section-label">Documentos</div>
  <div class="file-list" id="docList"><div class="empty">Carregando...</div></div>
</div>

<input type="file" id="fileInput" multiple onchange="handleFileSelect(this)">
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
  if (!await App.requireAuth()) return;
  loadStorageInfo();
});

async function loadStorageInfo() {
  const { data } = await window.supabaseClient.storage.from('media').list(`user_files/${App.currentUser.id}`);
  let totalBytes = 0;
  (data||[]).forEach(f => totalBytes += f.metadata?.size||0);
  const mb = (totalBytes / 1024 / 1024).toFixed(1);
  document.getElementById('storageUsed').textContent = `${mb} MB`;
  document.getElementById('storageFill').style.width = Math.min(100, totalBytes / (1024*1024*1024) * 100) + '%';
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active');
  document.getElementById('uploadTab').style.display = tab==='upload'?'block':'none';
  document.getElementById('imagesTab').style.display = tab==='images'?'block':'none';
  document.getElementById('docsTab').style.display = tab==='docs'?'block':'none';
  if (tab==='images') loadImages();
  if (tab==='docs') loadDocs();
}

async function loadImages() {
  const { data } = await window.supabaseClient.storage.from('media').list(`user_files/${App.currentUser.id}/images`);
  const grid = document.getElementById('imageGrid');
  if (!data||!data.length) { grid.innerHTML = '<div class="empty">Nenhuma imagem</div>'; return; }
  grid.innerHTML = '';
  data.forEach(f => {
    const { data: url } = window.supabaseClient.storage.from('media').getPublicUrl(`user_files/${App.currentUser.id}/images/${f.name}`);
    const card = document.createElement('div'); card.className='file-card';
    card.innerHTML = `<div class="file-preview"><img src="${url.publicUrl}" loading="lazy"></div>
      <div class="file-info"><div class="file-name">${f.name}</div><div class="file-size">${formatBytes(f.metadata?.size||0)}</div></div>`;
    card.onclick = () => window.open(url.publicUrl, '_blank');
    grid.appendChild(card);
  });
}

async function loadDocs() {
  const { data } = await window.supabaseClient.storage.from('media').list(`user_files/${App.currentUser.id}/docs`);
  const list = document.getElementById('docList');
  if (!data||!data.length) { list.innerHTML = '<div class="empty">Nenhum documento</div>'; return; }
  list.innerHTML = '';
  data.forEach(f => {
    const ext = f.name.split('.').pop().toLowerCase();
    const icons = { pdf:'üìÑ', doc:'üìù', docx:'üìù', xls:'üìä', xlsx:'üìä', zip:'üóúÔ∏è', mp3:'üéµ', mp4:'üé¨' };
    const { data: url } = window.supabaseClient.storage.from('media').getPublicUrl(`user_files/${App.currentUser.id}/docs/${f.name}`);
    const row = document.createElement('div'); row.className='file-row';
    row.innerHTML = `<div class="file-row-icon">${icons[ext]||'üìé'}</div>
      <div class="file-row-info"><div class="file-row-name">${f.name}</div><div class="file-row-meta">${formatBytes(f.metadata?.size||0)} ¬∑ ${ext.toUpperCase()}</div></div>
      <a href="${url.publicUrl}" target="_blank" style="color:var(--primary-light);font-size:13px;text-decoration:none;">Abrir</a>
      <button class="delete-btn" onclick="deleteFile('${f.name}','docs')">üóë</button>`;
    list.appendChild(row);
  });
}

function dragOver(e) { e.preventDefault(); document.getElementById('dropZone').classList.add('drag'); }
function dragLeave() { document.getElementById('dropZone').classList.remove('drag'); }
function dropFile(e) { e.preventDefault(); dragLeave(); if (e.dataTransfer.files.length) processFiles(e.dataTransfer.files); }
function handleFileSelect(input) { if (input.files.length) processFiles(input.files); }

async function processFiles(files) {
  for (const file of files) {
    if (file.size > 50*1024*1024) { showToast('Arquivo muito grande (m√°x 50MB)'); continue; }
    await uploadFile(file);
  }
}

async function uploadFile(file) {
  const isImage = file.type.startsWith('image/');
  const folder = isImage ? 'images' : 'docs';
  const path = `user_files/${App.currentUser.id}/${folder}/${Date.now()}_${file.name}`;

  const card = document.getElementById('progressCard');
  const fill = document.getElementById('progressFill');
  const pct = document.getElementById('progressPct');
  document.getElementById('progressFile').textContent = file.name;
  card.classList.add('show'); fill.style.width='0%'; pct.textContent='0%';

  // Simulate progress with XHR
  try {
    // Simple upload with progress simulation
    let progress = 0;
    const interval = setInterval(() => {
      progress = Math.min(90, progress + 10);
      fill.style.width = progress + '%';
      pct.textContent = progress + '%';
    }, 200);

    const { error } = await window.supabaseClient.storage.from('media').upload(path, file);
    clearInterval(interval);
    if (error) throw error;

    fill.style.width = '100%'; pct.textContent = '100%';
    setTimeout(() => { card.classList.remove('show'); }, 1500);
    showToast('‚úÖ ' + file.name + ' enviado!');
    loadStorageInfo();
  } catch(e) {
    card.classList.remove('show');
    showToast('Erro no upload: ' + e.message);
  }
}

async function deleteFile(name, folder) {
  if (!confirm(`Excluir ${name}?`)) return;
  await window.supabaseClient.storage.from('media').remove([`user_files/${App.currentUser.id}/${folder}/${name}`]);
  showToast('Exclu√≠do!');
  folder==='images' ? loadImages() : loadDocs();
  loadStorageInfo();
}

function formatBytes(b) { if (b < 1024) return b+'B'; if (b < 1048576) return (b/1024).toFixed(1)+'KB'; return (b/1048576).toFixed(1)+'MB'; }
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>
