<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Grupo - ChiaraGo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a1a">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a1a;--surface:#13132a;--surface2:#1a1a35;--border:rgba(124,58,237,.2);--border2:rgba(124,58,237,.4);--primary:#7c3aed;--primary-light:#9d5cf8;--accent:#f472b6;--text:#f0f0ff;--text2:#a0a0c0;--text3:#606080;--online:#22c55e;--radius:16px;--radius-sm:10px;--radius-full:9999px;--font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 12px max(10px,env(safe-area-inset-top));display:flex;align-items:center;gap:10px;}
  .back-btn{color:var(--text2);padding:6px;cursor:pointer;display:flex;align-items:center;text-decoration:none;}
  .back-btn svg{width:22px;height:22px;}
  .group-avatar{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#f472b6);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;overflow:hidden;}
  .group-avatar img{width:100%;height:100%;object-fit:cover;}
  .header-info{flex:1;min-width:0;cursor:pointer;}
  .header-name{font-family:var(--font-head);font-weight:700;font-size:16px;}
  .header-sub{font-size:12px;color:var(--text3);}
  .icon-btn{color:var(--text2);padding:7px;cursor:pointer;border-radius:8px;transition:background .2s;display:flex;}
  .icon-btn:hover{background:var(--surface2);}
  .icon-btn svg{width:20px;height:20px;}
  .messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:4px;scroll-behavior:smooth;}
  .day-divider{text-align:center;margin:12px 0;}
  .day-label{background:var(--surface);border:1px solid var(--border);color:var(--text3);font-size:11px;padding:4px 12px;border-radius:var(--radius-full);}
  .msg{display:flex;gap:8px;max-width:80%;animation:msgIn .2s ease;}
  @keyframes msgIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;}}
  .msg.sent{align-self:flex-end;flex-direction:row-reverse;}
  .msg.received{align-self:flex-start;}
  .msg-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;align-self:flex-end;overflow:hidden;}
  .msg-avatar img{width:100%;height:100%;object-fit:cover;}
  .msg-bubble{background:var(--surface2);border-radius:18px;padding:10px 14px;border-bottom-left-radius:4px;max-width:100%;word-break:break-word;}
  .msg.sent .msg-bubble{background:linear-gradient(135deg,var(--primary),var(--primary-light));border-bottom-left-radius:18px;border-bottom-right-radius:4px;color:#fff;}
  .msg-sender{font-size:12px;font-weight:600;color:var(--primary-light);margin-bottom:3px;}
  .msg.sent .msg-sender{display:none;}
  .msg-text{font-size:15px;line-height:1.5;}
  .msg-meta{display:flex;align-items:center;gap:4px;margin-top:4px;}
  .msg-time{font-size:10px;opacity:.6;}
  .msg.sent .msg-time{color:rgba(255,255,255,.7);}
  .input-area{background:var(--surface);border-top:1px solid var(--border);padding:8px 12px max(8px,env(safe-area-inset-bottom));}
  .input-wrap{display:flex;align-items:flex-end;gap:8px;}
  .attach-btn{color:var(--text3);padding:8px;cursor:pointer;display:flex;align-items:center;}
  .attach-btn svg{width:22px;height:22px;}
  .msg-input-wrap{flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:22px;padding:10px 14px;transition:border-color .2s;}
  .msg-input-wrap:focus-within{border-color:var(--primary);}
  .msg-input{outline:none;color:var(--text);font-family:var(--font-body);font-size:15px;background:transparent;resize:none;border:none;width:100%;}
  .msg-input[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--text3);}
  .send-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .15s;flex-shrink:0;}
  .send-btn:hover{transform:scale(1.05);}
  .send-btn svg{width:20px;height:20px;}
  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;}
  .modal-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 20px;}
  .modal h3{font-family:var(--font-head);font-size:18px;margin-bottom:16px;}
  .member-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
  .member-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;overflow:hidden;}
  .member-avatar img{width:100%;height:100%;object-fit:cover;}
  .member-info{flex:1;}
  .member-name{font-weight:600;font-size:15px;}
  .member-role{font-size:12px;color:var(--text3);}
  .online-dot{width:8px;height:8px;background:var(--online);border-radius:50%;}
  .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);color:var(--text);padding:12px 24px;border-radius:var(--radius-full);font-size:14px;opacity:0;transition:all .3s;z-index:9999;border:1px solid var(--border2);}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .btn{padding:10px 20px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;border-radius:var(--radius-full);color:#fff;font-family:var(--font-head);font-weight:700;cursor:pointer;font-size:14px;}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);}
</style>
</head>
<body>
<header class="header">
  <a href="index.html" class="back-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></a>
  <div class="group-avatar" id="groupAvatar">ðŸ‘¥</div>
  <div class="header-info" onclick="showInfo()">
    <div class="header-name" id="groupName">Carregando...</div>
    <div class="header-sub" id="memberCount">0 membros</div>
  </div>
  <div class="icon-btn" onclick="showInfo()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
  </div>
</header>

<div class="messages" id="messages">
  <div style="text-align:center;padding:40px;opacity:.4;font-size:14px;color:var(--text3)">Carregando...</div>
</div>

<div class="input-area">
  <div class="input-wrap">
    <div class="attach-btn" onclick="attachFile()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg></div>
    <div class="msg-input-wrap">
      <div class="msg-input" id="msgInput" contenteditable="true" data-placeholder="Mensagem para o grupo..." onkeydown="handleKey(event)"></div>
    </div>
    <button class="send-btn" onclick="sendMessage()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>
  </div>
</div>

<!-- Group Info Modal -->
<div class="modal-overlay" id="infoModal" onclick="closeModal(event)">
  <div class="modal" id="infoContent">
    <div class="modal-handle"></div>
    <h3 id="modalGroupName">Grupo</h3>
    <p id="modalGroupDesc" style="color:var(--text2);font-size:14px;margin-bottom:20px;"></p>
    <div style="margin-bottom:16px;"><strong>Membros</strong></div>
    <div id="membersList"></div>
    <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn" onclick="addMember()">+ Adicionar</button>
      <button class="btn btn-danger" onclick="leaveGroup()">Sair do Grupo</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
<script src="grupos.js"></script>
<script>
let groupId = new URLSearchParams(window.location.search).get('id');
let group = null, members = [], msgChannel = null;

document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
  if (!await App.requireAuth()) return;
  if (!groupId) { window.location.href='index.html'; return; }
  await loadGroup();
  await loadMessages();
  msgChannel = Grupos.inscreverMensagens(groupId, payload => {
    const container = document.getElementById('messages');
    const at = container.scrollHeight - container.scrollTop - container.clientHeight < 60;
    container.appendChild(createMsgEl(payload.new));
    if (at) container.scrollTop = container.scrollHeight;
  });
});

async function loadGroup() {
  const { data: g } = await window.supabaseClient.from('groups').select('*').eq('id', groupId).single();
  group = g;
  document.getElementById('groupName').textContent = g.name;
  document.title = `${g.name} - ChiaraGo`;
  const av = document.getElementById('groupAvatar');
  if (g.avatar_url) av.innerHTML = `<img src="${g.avatar_url}">`;
  else av.textContent = g.name[0];
  members = await Grupos.buscarMembros(groupId);
  document.getElementById('memberCount').textContent = `${members.length} membros`;
}

async function loadMessages() {
  const msgs = await Grupos.buscarMensagens(groupId);
  const c = document.getElementById('messages');
  if (!msgs.length) { c.innerHTML = `<div style="text-align:center;padding:60px;opacity:.4;"><div style="font-size:48px">ðŸ‘¥</div><div style="font-size:14px;color:var(--text3);margin-top:8px">Nenhuma mensagem</div></div>`; return; }
  c.innerHTML = '';
  let lastDate = null;
  msgs.forEach(msg => {
    const d = new Date(msg.created_at).toDateString();
    if (d !== lastDate) {
      const div = document.createElement('div'); div.className='day-divider';
      div.innerHTML=`<span class="day-label">${App.formatDate(msg.created_at)}</span>`;
      c.appendChild(div); lastDate=d;
    }
    c.appendChild(createMsgEl(msg));
  });
  c.scrollTop = c.scrollHeight;
}

function createMsgEl(msg) {
  const isSent = msg.sender_id === App.currentUser.id;
  const sender = msg.profiles;
  const div = document.createElement('div');
  div.className = `msg ${isSent?'sent':'received'}`;
  div.innerHTML = `
    ${!isSent?`<div class="msg-avatar">${sender?.avatar_url?`<img src="${sender.avatar_url}">`:(sender?.full_name||'?')[0]}</div>`:''}
    <div class="msg-bubble">
      <div class="msg-sender">${sender?.full_name||sender?.username||''}</div>
      <div class="msg-text">${(msg.content||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>
      <div class="msg-meta"><span class="msg-time">${App.formatTime(msg.created_at)}</span></div>
    </div>`;
  return div;
}

async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.textContent.trim();
  if (!text) return;
  input.textContent = '';
  await Grupos.enviarMensagem(groupId, text);
}

function handleKey(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

function showInfo() {
  document.getElementById('modalGroupName').textContent = group?.name || '';
  document.getElementById('modalGroupDesc').textContent = group?.description || '';
  const list = document.getElementById('membersList');
  list.innerHTML = '';
  members.forEach(m => {
    const p = m.profiles;
    const item = document.createElement('div'); item.className = 'member-item';
    item.innerHTML = `
      <div class="member-avatar">${p?.avatar_url?`<img src="${p.avatar_url}">`:(p?.full_name||'?')[0]}</div>
      <div class="member-info"><div class="member-name">${p?.full_name||p?.username}</div><div class="member-role">${m.role==='admin'?'ðŸ‘‘ Admin':'Membro'}</div></div>
      ${p?.is_online?'<div class="online-dot"></div>':''}`;
    list.appendChild(item);
  });
  document.getElementById('infoModal').classList.add('open');
}

function closeModal(e) { if (e.target.classList.contains('modal-overlay')) document.getElementById('infoModal').classList.remove('open'); }
async function leaveGroup() { if(confirm('Sair do grupo?')) { await Grupos.sairDoGrupo(groupId); window.location.href='index.html'; } }
function addMember() { App.showToast('Funcionalidade em breve!'); }
function attachFile() { App.showToast('Funcionalidade em breve!'); }
</script>
</body>
</html>
