<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>NotificaÃ§Ãµes - ChiaraGo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a1a;--surface:#13132a;--surface2:#1a1a35;--border:rgba(124,58,237,.2);--primary:#7c3aed;--primary-light:#9d5cf8;--accent:#f472b6;--text:#f0f0ff;--text2:#a0a0c0;--text3:#606080;--online:#22c55e;--radius:16px;--radius-sm:10px;--radius-full:9999px;--font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100dvh;}
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:max(12px,env(safe-area-inset-top)) 16px 12px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50;}
  .back-btn{color:var(--text2);padding:6px;cursor:pointer;text-decoration:none;display:flex;}
  .back-btn svg{width:22px;height:22px;}
  .header-title{font-family:var(--font-head);font-size:18px;font-weight:700;flex:1;}
  .mark-all{background:none;border:none;color:var(--primary-light);font-family:var(--font-body);font-size:13px;cursor:pointer;padding:4px 8px;}
  .page{padding:0 0 80px;}
  .section-header{padding:12px 16px 6px;color:var(--text3);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;}
  .notif-item{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid rgba(255,255,255,.03);position:relative;}
  .notif-item.unread{background:rgba(124,58,237,.05);}
  .notif-item:hover{background:var(--surface);}
  .notif-icon{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
  .notif-icon-msg{background:rgba(56,189,248,.15);}
  .notif-icon-call{background:rgba(34,197,94,.15);}
  .notif-icon-group{background:rgba(124,58,237,.15);}
  .notif-icon-contact{background:rgba(244,114,182,.15);}
  .notif-info{flex:1;min-width:0;}
  .notif-title{font-weight:600;font-size:15px;}
  .notif-body{color:var(--text2);font-size:13px;margin-top:3px;line-height:1.4;}
  .notif-time{font-size:11px;color:var(--text3);margin-top:4px;}
  .unread-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;flex-shrink:0;margin-top:6px;}
  .notif-actions{display:flex;gap:8px;margin-top:8px;}
  .notif-btn{padding:6px 14px;border-radius:var(--radius-full);font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:var(--font-body);}
  .notif-btn-accept{background:var(--online);color:#fff;}
  .notif-btn-decline{background:var(--surface2);color:var(--text2);}
  .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 24px;gap:12px;text-align:center;}
  .empty-icon{font-size:56px;opacity:.3;}
  .empty-state p{color:var(--text3);font-size:14px;}
  .loading-dots{display:flex;gap:6px;justify-content:center;padding:32px;}
  .dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:bounce .6s infinite alternate;}
  .dot:nth-child(2){animation-delay:.2s;} .dot:nth-child(3){animation-delay:.4s;}
  @keyframes bounce{to{transform:translateY(-8px);opacity:.4;}}
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));z-index:100;}
  .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 12px;cursor:pointer;color:var(--text3);text-decoration:none;transition:color .2s;}
  .nav-item.active,.nav-item:hover{color:var(--primary-light);}
  .nav-item svg{width:24px;height:24px;}
  .nav-item span{font-size:10px;font-weight:500;}
</style>
</head>
<body>
<header class="header">
  <a href="index.html" class="back-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></a>
  <div class="header-title">NotificaÃ§Ãµes</div>
  <button class="mark-all" onclick="Notificacoes.marcarTodasLidas().then(loadNotifs)">Marcar tudo como lido</button>
</header>

<div class="page">
  <div id="loading" class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  <div id="notifsList"></div>
  <div class="empty-state" id="emptyState" style="display:none">
    <div class="empty-icon">ðŸ””</div>
    <h3 style="font-family:var(--font-head);font-size:18px;">Tudo em dia!</h3>
    <p>VocÃª nÃ£o tem nenhuma notificaÃ§Ã£o no momento.</p>
  </div>
</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><span>Chats</span></a>
  <a href="status.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3"/></svg><span>Status</span></a>
  <a href="contatos.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Contatos</span></a>
  <a href="notificacoes.html" class="nav-item active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span>Alertas</span></a>
  <a href="configuracoes.html" class="nav-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg><span>Config.</span></a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="app.js"></script>
<script src="notificacoes.js"></script>
<script>
const icons = { message:'ðŸ’¬', call:'ðŸ“ž', group:'ðŸ‘¥', contact:'ðŸ‘¤', system:'ðŸ””' };
const iconClass = { message:'notif-icon-msg', call:'notif-icon-call', group:'notif-icon-group', contact:'notif-icon-contact' };

document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
  if (!await App.requireAuth()) return;
  await loadNotifs();
  Notificacoes.inscrever();
  document.addEventListener('nova-notificacao', () => loadNotifs());
});

async function loadNotifs() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const notifs = await Notificacoes.listar();
    document.getElementById('loading').style.display = 'none';
    const list = document.getElementById('notifsList');
    const empty = document.getElementById('emptyState');
    list.innerHTML = '';

    if (!notifs.length) { empty.style.display = 'flex'; return; }
    empty.style.display = 'none';

    let lastDate = null;
    notifs.forEach(n => {
      const d = App.formatDate(n.created_at);
      if (d !== lastDate) {
        const h = document.createElement('div'); h.className='section-header'; h.textContent=d;
        list.appendChild(h); lastDate=d;
      }
      const content = Notificacoes.formatarConteudo(n);
      const item = document.createElement('div');
      item.className = `notif-item ${n.is_read?'':'unread'}`;
      item.innerHTML = `
        <div class="notif-icon ${iconClass[n.type]||''}">${icons[n.type]||'ðŸ””'}</div>
        <div class="notif-info">
          <div class="notif-title">${content.text}</div>
          <div class="notif-time">${App.formatTime(n.created_at)}</div>
          ${n.type==='call'&&!n.is_read?`<div class="notif-actions"><button class="notif-btn notif-btn-accept" onclick="acceptCall('${n.id}','${n.content}')">Retornar</button><button class="notif-btn notif-btn-decline" onclick="dismiss('${n.id}')">Dispensar</button></div>`:''}
        </div>
        ${n.is_read?'':`<div class="unread-dot"></div>`}`;
      item.onclick = async () => {
        await Notificacoes.marcarLida(n.id);
        item.classList.remove('unread');
        item.querySelector('.unread-dot')?.remove();
        Notificacoes.navegarParaNotif(n);
      };
      list.appendChild(item);
    });
  } catch(e) {
    document.getElementById('loading').style.display = 'none';
  }
}

async function dismiss(id) { await Notificacoes.marcarLida(id); await loadNotifs(); }
function acceptCall(notifId, content) { const d = JSON.parse(content); window.location.href = `chamada.html?call=${d.callId}`; }
</script>
</body>
</html>
